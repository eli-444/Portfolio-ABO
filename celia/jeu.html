<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maternity world - Mobile Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS GLOBAL --- */
        body {
            background-color: #121212;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: white;
            user-select: none;
            -webkit-user-select: none; /* Safari */
            touch-action: none; /* Emp√™che le zoom tactile */
        }

        #game-wrapper {
            position: relative;
            /* Le jeu garde son ratio 4:3 mais s'adapte √† l'√©cran */
            width: 100%;
            max-width: 1024px; 
            aspect-ratio: 4/3;
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
            border: 4px solid #f0f0f0;
            border-radius: 8px;
            background: #000;
        }

        /* Le canvas prend toute la place du wrapper */
        canvas { 
            display: block; 
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
        }

        /* --- INTERFACE --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 5;
        }

        #top-bar {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-shadow: 2px 2px 0 #000;
            pointer-events: auto;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            font-size: 10px; /* Plus petit pour mobile */
        }

        @media (min-width: 600px) { #top-bar { font-size: 16px; padding: 15px; } }

        .badge-slot {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid #fff;
            background: rgba(0,0,0,0.5);
            margin-left: 2px;
            border-radius: 50%;
            box-shadow: inset 0 0 5px #000;
        }
        @media (min-width: 600px) { .badge-slot { width: 24px; height: 24px; margin-left: 5px; } }
        
        .badge-active { box-shadow: 0 0 10px #fff, inset 0 0 5px rgba(255,255,255,0.5); border-color: gold; }

        /* --- CONTR√îLES TACTILES --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 150px;
            pointer-events: none;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* D-PAD (Gauche) */
        .d-pad {
            pointer-events: auto;
            width: 120px;
            height: 120px;
            position: relative;
        }
        .d-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: rgba(255, 255, 255, 0.8);
            touch-action: none;
        }
        .d-btn:active { background: rgba(255, 255, 255, 0.5); }
        #btn-up { top: 0; left: 40px; }
        #btn-down { bottom: 0; left: 40px; }
        #btn-left { top: 40px; left: 0; }
        #btn-right { top: 40px; right: 0; }

        /* ACTION BUTTONS (Droite) */
        .action-group {
            pointer-events: auto;
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        
        .action-btn {
            background: rgba(194, 24, 91, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            touch-action: none;
        }
        .action-btn:active { background: rgba(194, 24, 91, 0.8); transform: scale(0.95); }
        
        #btn-shift {
            width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); margin-bottom: 10px;
        }
        #btn-shift.active { background: #FFEB3B; color: black; }

        /* Pour cacher les contr√¥les sur PC si on veut, mais on les laisse pour les √©crans tactiles hybrides */
        @media (hover: hover) and (pointer: fine) {
            /* Optionnel: d√©commenter pour cacher sur PC */
            /* #mobile-controls { display: none; } */
        }


        /* Boite de Dialogue */
        #dialogue-box {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #333;
            border-radius: 8px;
            margin: 20px;
            padding: 15px;
            min-height: 120px;
            color: #333;
            pointer-events: auto;
            display: none;
            flex-direction: column;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            animation: slideUp 0.3s ease-out;
            /* Centrer sur mobile */
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            z-index: 30; /* Au dessus des contr√¥les */
        }
        @media (min-width: 600px) { #dialogue-box { font-size: 18px; padding: 20px; } }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #npc-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: #d32f2f;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        #dialogue-content { flex-grow: 1; margin-bottom: 15px; }

        #options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button.choice-btn {
            background: #fff; border: 2px solid #ccc; padding: 10px; cursor: pointer;
            font-family: 'Press Start 2P', cursive; font-size: 10px; text-align: left;
            transition: 0.2s; border-radius: 4px; touch-action: manipulation;
        }
        button.choice-btn:hover, button.choice-btn:active { background: #333; color: #fff; border-color: #333; }

        /* √âcran de Titre */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 50; text-align: center;
        }
        h1 { font-size: 24px; color: #c2185b; text-shadow: 2px 2px 0 #fff; margin-bottom: 20px; line-height: 1.5; }
        @media (min-width: 600px) { h1 { font-size: 45px; text-shadow: 4px 4px 0 #fff; } }
        
        p { font-size: 10px; color: #333; margin-bottom: 30px; font-family: 'Roboto'; font-weight: bold; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;}
        @media (min-width: 600px) { p { font-size: 14px; margin-bottom: 40px; } }

        .start-btn {
            padding: 15px 30px; font-size: 14px; font-family: 'Press Start 2P', cursive;
            background: #c2185b; color: white; border: 4px solid white; cursor: pointer;
            animation: pulse 1s infinite; box-shadow: 0 5px 15px rgba(194, 24, 91, 0.4);
            border-radius: 50px;
        }
        @media (min-width: 600px) { .start-btn { padding: 20px 50px; font-size: 18px; } }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <audio id="background-music" loop>
        <source src="audiosrc/fallendown.mp3" type="audio/mpeg">
    </audio>

    <div id="game-wrapper">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="ui-layer">
            <div id="top-bar">
                <div id="toggle-music" style="cursor: pointer;">C√âLIA'S WORLD üîä</div>
                <div id="badge-container">
                    <span id="badge-1" class="badge-slot"></span>
                    <span id="badge-2" class="badge-slot"></span>
                    <span id="badge-3" class="badge-slot"></span>
                    <span id="badge-4" class="badge-slot"></span>
                </div>
            </div>

            <div id="mobile-controls">
                <div class="d-pad">
                    <div class="d-btn" id="btn-up">‚ñ≤</div>
                    <div class="d-btn" id="btn-left">‚óÄ</div>
                    <div class="d-btn" id="btn-right">‚ñ∂</div>
                    <div class="d-btn" id="btn-down">‚ñº</div>
                </div>
                <div class="action-group">
                    <div class="action-btn" id="btn-shift">RUN</div>
                    <div class="action-btn" id="btn-action">A</div>
                </div>
            </div>

            <div id="dialogue-box">
                <div id="npc-name">Nom PNJ</div>
                <div id="dialogue-content">...</div>
                <div id="options"></div>
            </div>
        </div>

        <div id="title-screen">
            <h1>POUR TOI C√âLIA</h1>
            <p>PC: Fl√®ches/Espace<br>MOBILE: Touches tactiles</p>
            <button class="start-btn" onclick="startGame()">COMMENCER</button>
        </div>
    </div>

<script>
// --- GESTION MUSIQUE ---
const music = document.getElementById("background-music");
const toggleBtn = document.getElementById("toggle-music");

function initMusic() {
    music.volume = 0.1; 
    music.play().catch(e => console.log(e));
}

toggleBtn.addEventListener("click", function () {
    if (music.paused) { music.play(); toggleBtn.innerText = "C√âLIA'S WORLD üîä"; } 
    else { music.pause(); toggleBtn.innerText = "C√âLIA'S WORLD üîá"; }
});

// --- GESTION DES TOUCHES TACTILES ---
// On simule l'appui sur les touches du clavier
function simulateKey(code, type) {
    const event = new KeyboardEvent(type, { code: code });
    window.dispatchEvent(event);
}

function setupTouchControl(id, code) {
    const btn = document.getElementById(id);
    // Emp√™cher le menu contextuel au clic long
    btn.addEventListener('contextmenu', e => e.preventDefault());
    
    // Touch Start
    btn.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Emp√™che le scroll
        simulateKey(code, 'keydown');
        if (id !== 'btn-shift') btn.style.background = 'rgba(255,255,255,0.5)';
    }, {passive: false});

    // Touch End
    btn.addEventListener('touchend', (e) => {
        e.preventDefault();
        simulateKey(code, 'keyup');
        if (id !== 'btn-shift') btn.style.background = '';
    }, {passive: false});

    // Souris (pour tester sur PC aussi)
    btn.addEventListener('mousedown', (e) => {
        simulateKey(code, 'keydown');
    });
    btn.addEventListener('mouseup', (e) => {
        simulateKey(code, 'keyup');
    });
}

// Configuration sp√©cifique pour le Shift (Toggle ou Hold ?) -> On va faire Hold
setupTouchControl('btn-up', 'ArrowUp');
setupTouchControl('btn-down', 'ArrowDown');
setupTouchControl('btn-left', 'ArrowLeft');
setupTouchControl('btn-right', 'ArrowRight');
setupTouchControl('btn-action', 'Space');
setupTouchControl('btn-shift', 'ShiftLeft');


/* ==========================================================================
   DONN√âES P√âDAGOGIQUES
   ========================================================================== */
const ANECDOTES = [
    { name: "Pika-Psy", text: "Pika ! Le 'Syndrome du 3√®me jour' touche 50 √† 80% des femmes. C'est √©norme mais b√©nin !" },
    { name: "Rondoudou-Love", text: "Doudou... Ren√© Spitz a montr√© que sans amour, les b√©b√©s souffrent d'hospitalisme." },
    { name: "Bulbi-Soins", text: "Bulbi ! En n√©onat, le p√®re est un 'agent de liaison'. Il fait le pont entre maman et b√©b√©." },
    { name: "Cara-Cool", text: "Squirtle ! Winnicott parle de la 'pr√©occupation maternelle primaire'. Une sensibilit√© magique." },
    { name: "Pika-Psy", text: "Chuu... Le silence face au handicap est pire que tout. L'annonce doit √™tre faite avec v√©rit√©." },
    { name: "Rondoudou-Love", text: "Zzz... Le peau-√†-peau r√©duit la douleur des pr√©matur√©s." }
];

const QUIZ_DATA = {
    MODULE_1: { 
        name: "Dr. Perinat", color: "#3498db",
        dialogue: "Bienvenue √† la Maternit√©. Ici, nous traitons les difficult√©s pr√©coces. Prouve-moi que tu as lu le cours.",
        questions: [
            { q: "Quelle est la pr√©valence moyenne de la D√©pression Post-Partum (DPP) ?", a: ["5%", "13%", "50%"], correct: 1 },
            { q: "Quel est l'outil de r√©f√©rence pour le d√©pistage de la DPP ?", a: ["Score d'Apgar", "√âchelle EPDS", "Test de Rorschach"], correct: 1 },
            { q: "Le 'Baby Blues' est-il pathologique ?", a: ["Oui, toujours", "Non, c'est banal", "Seulement s'il dure > 1 mois"], correct: 1 },
            { q: "Parmi ces facteurs, lequel est un risque de DPP ?", a: ["Ant√©c√©dents psy", "Manger du chocolat", "Avoir 25 ans"], correct: 0 }
        ]
    },
    MODULE_2: { 
        name: "Prof. Bowlby", color: "#f1c40f",
        dialogue: "Nous √©tudions ici le lien m√®re-enfant. C'est crucial. Es-tu pr√™te ?",
        questions: [
            { q: "Qui a d√©velopp√© le concept d'Hospitalisme ?", a: ["Winnicott", "Ren√© Spitz", "Freud"], correct: 1 },
            { q: "Vers quel √¢ge appara√Æt l'angoisse de s√©paration ?", a: ["8 mois", "D√®s la naissance", "2 ans"], correct: 0 },
            { q: "Une s√©paration est pathog√®ne si elle est...", a: ["Expliqu√©e", "Brutale et prolong√©e", "Temporaire"], correct: 1 },
            { q: "Winnicott appelle la sensibilit√© accrue de la m√®re la...", a: ["Fusion totale", "Pr√©occupation Maternelle Primaire", "N√©vrose"], correct: 1 }
        ]
    },
    MODULE_3: {
        name: "Mme √âthique", color: "#2ecc71",
        dialogue: "L'annonce est un moment d√©licat. Voyons si tu ma√Ætrises les protocoles.",
        questions: [
            { q: "Lors de l'annonce, faut-il parler d'embl√©e de 'handicap' ?", a: ["Oui, √™tre clair", "Non, √©viter ce mot au d√©but", "Seulement au p√®re"], correct: 1 },
            { q: "Qui doit √™tre pr√©sent lors de l'annonce postnatale ?", a: ["La m√®re seule", "Les deux parents + le b√©b√©", "Juste le m√©decin"], correct: 1 },
            { q: "Que signifie le sigle CAMSP ?", a: ["Centre d'Action M√©dico-Sociale Pr√©coce", "Comit√© d'Aide Maternelle", "Centre d'Apprentissage"], correct: 0 },
            { q: "Quel principe est FAUX concernant l'annonce ?", a: ["Dire la v√©rit√©", "Pr√©server l'avenir", "Cacher les incertitudes"], correct: 2 }
        ]
    },
    MODULE_4: {
        name: "Infirmier Marc", color: "#e67e22",
        dialogue: "Le service de N√©onatologie est intense. La pr√©maturit√© est un traumatisme.",
        questions: [
            { q: "Le r√¥le du p√®re en n√©onatologie est d√©crit comme...", a: ["Un observateur", "Un agent de liaison (pont)", "Un obstacle"], correct: 1 },
            { q: "Le programme de soins individualis√©s se nomme...", a: ["NIDCAP", "APGAR", "LAMAZE"], correct: 0 },
            { q: "Pourquoi l'attachement est souvent pr√©serv√© chez les pr√©matur√©s ?", a: ["Il se joue apr√®s 6 semaines", "Ils ne ressentent rien", "C'est magique"], correct: 0 },
            { q: "Le b√©b√© pr√©matur√© peut vivre une...", a: ["Agonie primitive", "Joie intense", "Paix int√©rieure"], correct: 0 }
        ]
    }
};

/* ==========================================================================
   MOTEUR DU JEU
   ========================================================================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameStarted = false;
let gameState = 'OVERWORLD'; 
let currentZone = 'VILLAGE'; 
let frameCount = 0;
let badges = [false, false, false, false]; 

// ENTIT√âS
const player = { x: 400, y: 300, w: 32, h: 48, speed: 4, runSpeed: 7, dir: 0, moving: false, frame: 0 };
const camera = { x: 0, y: 0 };
const keys = {};

// G√©n√©ration des Pok√©mon
const pokemons = [];
const pokeTypes = ['PIKA', 'RON', 'BULB', 'CARA'];
for(let i=0; i<8; i++) {
    pokemons.push({
        type: pokeTypes[i % 4],
        x: Math.random() * 1000 + 100,
        y: Math.random() * 1000 + 100,
        w: 30, h: 30,
        dir: Math.floor(Math.random()*4),
        moving: false,
        moveTimer: 0,
        anecdote: ANECDOTES[i % ANECDOTES.length]
    });
}

// ASSETS GRAPHIQUES
function drawPlayerSprite(x, y, dir, frame) {
    ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(x+16, y+44, 12, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#1976D2"; ctx.fillRect(x+6, y+20, 20, 18);
    ctx.fillStyle = "#263238"; 
    let legOffset = player.moving ? Math.sin(frameCount * 0.2) * 5 : 0;
    ctx.fillRect(x+8, y+38, 7, 10 + legOffset);
    ctx.fillRect(x+17, y+38, 7, 10 - legOffset);
    ctx.fillStyle = "#FFCCBC"; ctx.fillRect(x+6, y+2, 20, 18);
    ctx.fillStyle = "#D32F2F"; ctx.fillRect(x+4, y, 24, 6); 
    if (dir === 0) ctx.fillRect(x+4, y+6, 24, 2); 
    if (dir === 2) ctx.fillRect(x, y+6, 6, 2); 
    if (dir === 3) ctx.fillRect(x+26, y+6, 6, 2); 
    ctx.fillStyle = "black";
    if (dir === 0) { ctx.fillRect(x+10, y+8, 2, 4); ctx.fillRect(x+20, y+8, 2, 4); }
    else if (dir === 2) { ctx.fillRect(x+6, y+8, 2, 4); }
    else if (dir === 3) { ctx.fillRect(x+24, y+8, 2, 4); }
}

function drawPokemon(p) {
    let bounce = p.moving ? Math.sin(frameCount*0.3)*3 : 0;
    let py = p.y + bounce;
    ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(p.x+15, p.y+28, 10, 4, 0, 0, Math.PI*2); ctx.fill();

    if (p.type === 'PIKA') {
        ctx.fillStyle = "#FFEB3B"; ctx.fillRect(p.x+5, py+10, 20, 18);
        ctx.fillRect(p.x+2, py+2, 8, 10); ctx.fillStyle="black"; ctx.fillRect(p.x+2, py+2, 8, 3);
        ctx.fillStyle="#FFEB3B"; ctx.fillRect(p.x+20, py+2, 8, 10); ctx.fillStyle="black"; ctx.fillRect(p.x+20, py+2, 8, 3);
        ctx.fillStyle = "#F44336"; ctx.beginPath(); ctx.arc(p.x+8, py+18, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(p.x+22, py+18, 3, 0, Math.PI*2); ctx.fill();
    } else if (p.type === 'RON') {
        ctx.fillStyle = "#F48FB1"; ctx.beginPath(); ctx.arc(p.x+15, py+15, 12, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(p.x+10, py+12, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(p.x+20, py+12, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(p.x+10, py+12, 1.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(p.x+20, py+12, 1.5, 0, Math.PI*2); ctx.fill();
    } else if (p.type === 'BULB') {
        ctx.fillStyle = "#81C784"; ctx.fillRect(p.x+5, py+12, 20, 15);
        ctx.fillStyle = "#00897B"; ctx.beginPath(); ctx.arc(p.x+15, py+8, 8, 0, Math.PI*2); ctx.fill();
    } else { 
        ctx.fillStyle = "#42A5F5"; ctx.beginPath(); ctx.arc(p.x+15, py+15, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#795548"; ctx.beginPath(); ctx.arc(p.x+15, py+20, 10, 0, Math.PI, false); ctx.fill();
    }
}

function drawTree(x, y) {
    ctx.fillStyle = "#5D4037"; ctx.fillRect(x+16, y+40, 16, 24);
    ctx.fillStyle = "#2E7D32"; ctx.beginPath(); ctx.arc(x+24, y+20, 24, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#388E3C"; ctx.beginPath(); ctx.arc(x+10, y+30, 20, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+38, y+30, 20, 0, Math.PI*2); ctx.fill();
}

function drawBush(x, y) {
    ctx.fillStyle = "#388E3C"; ctx.beginPath(); ctx.arc(x+10, y+10, 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+25, y+10, 12, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+40, y+10, 10, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = (x % 2 === 0) ? "#FFF" : "#FFEB3B"; ctx.fillRect(x+15, y+5, 4, 4); ctx.fillRect(x+35, y+12, 4, 4);
}

function drawRealisticFountain(x, y) {
    ctx.fillStyle = "#90A4AE"; ctx.beginPath(); ctx.arc(x, y, 60, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#607D8B"; ctx.beginPath(); ctx.arc(x, y, 50, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#039BE5"; ctx.beginPath(); ctx.arc(x, y, 45, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 2;
    let ripple1 = (frameCount % 60) / 60 * 40;
    let ripple2 = ((frameCount + 30) % 60) / 60 * 40;
    ctx.beginPath(); ctx.arc(x, y, ripple1, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(x, y, ripple2, 0, Math.PI*2); ctx.stroke();
    ctx.fillStyle = "white";
    for(let i=0; i<5; i++) {
        let angle = Math.random() * Math.PI * 2; let dist = Math.random() * 30;
        ctx.fillRect(x + Math.cos(angle)*dist, y + Math.sin(angle)*dist, 2, 2);
    }
}

function drawHouse(x, y, color, label) {
    ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.fillRect(x+10, y+10, 120, 100);
    ctx.fillStyle = "#ECEFF1"; ctx.fillRect(x, y+40, 120, 80);
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.moveTo(x-10, y+40); ctx.lineTo(x+60, y-20); ctx.lineTo(x+130, y+40); ctx.closePath(); ctx.fill();
    ctx.strokeStyle = "#263238"; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = "#3E2723"; ctx.fillRect(x+45, y+80, 30, 40);
    ctx.fillStyle = "#81D4FA"; ctx.fillRect(x+10, y+60, 25, 25); ctx.fillRect(x+85, y+60, 25, 25);
    ctx.fillStyle = "#333"; ctx.font = "10px sans-serif"; ctx.fillText(label, x+20, y+135);
}

function drawNPC(x, y, color) {
    ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(x+16, y+40, 10, 4, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.fillRect(x+8, y+15, 16, 25);
    ctx.fillStyle = "#FFCCBC"; ctx.fillRect(x+8, y, 16, 16);
    ctx.fillStyle = color; ctx.fillRect(x+6, y-2, 20, 8);
}

// LOGIQUE DU MONDE
const WORLDS = {
    VILLAGE: {
        w: 1200, h: 1200,
        draw: function() {
            ctx.fillStyle = "#66BB6A"; ctx.fillRect(0, 0, this.w, this.h);
            ctx.fillStyle = "#D7CCC8"; ctx.fillRect(550, 0, 100, 1200); ctx.fillRect(0, 550, 1200, 100);
            ctx.fillStyle = "#A1887F"; ctx.beginPath(); ctx.arc(600, 600, 140, 0, Math.PI*2); ctx.fill();
            drawRealisticFountain(600, 600);
            drawHouse(200, 200, "#42A5F5", "MATERNIT√â");
            drawHouse(800, 200, "#FFEE58", "PARC ENFANT");
            drawHouse(200, 800, "#66BB6A", "CENTRE MED");
            drawHouse(800, 800, "#EF5350", "N√âONAT");
            drawBush(100, 100); drawBush(160, 120); drawBush(900, 50); drawBush(1000, 80);
            drawBush(50, 900); drawBush(120, 950); drawBush(1050, 950); drawBush(950, 1000);
            drawBush(500, 500); drawBush(650, 500); drawBush(500, 680); drawBush(650, 680);
            drawTree(50, 50); drawTree(150, 50); drawTree(1000, 100); drawTree(1100, 150);
            drawTree(50, 1000); drawTree(150, 1100); drawTree(1000, 1000);
            pokemons.forEach(p => drawPokemon(p));
        },
        doors: [
            { x: 245, y: 320, w: 30, h: 10, target: 'HOUSE_1', targetX: 400, targetY: 500 },
            { x: 845, y: 320, w: 30, h: 10, target: 'HOUSE_2', targetX: 400, targetY: 500 },
            { x: 245, y: 920, w: 30, h: 10, target: 'HOUSE_3', targetX: 400, targetY: 500 },
            { x: 845, y: 920, w: 30, h: 10, target: 'HOUSE_4', targetX: 400, targetY: 500 }
        ]
    },
    INDOOR_TEMPLATE: function(color, moduleKey) {
        return {
            w: 800, h: 600,
            draw: function() {
                ctx.fillStyle = "#CFD8DC"; ctx.fillRect(0,0, 800, 600);
                ctx.fillStyle = color; ctx.globalAlpha = 0.2; ctx.fillRect(100, 100, 600, 400); ctx.globalAlpha = 1.0;
                ctx.fillStyle = "#455A64"; ctx.fillRect(0, 0, 800, 50); ctx.fillRect(0, 0, 50, 600); ctx.fillRect(750, 0, 50, 600);
                ctx.fillRect(0, 550, 350, 50); ctx.fillRect(450, 550, 350, 50);
                ctx.fillStyle = "#37474F"; ctx.fillRect(350, 550, 100, 50);
                drawNPC(380, 200, color);
                let modIndex = parseInt(moduleKey.split('_')[1]) - 1;
                if (!badges[modIndex]) {
                    ctx.fillStyle = "red"; ctx.font = "bold 20px Arial"; ctx.fillText("!", 390, 180 + Math.sin(frameCount*0.2)*5);
                } else {
                    ctx.fillStyle = "gold"; ctx.fillText("‚òÖ", 390, 180);
                }
            },
            doors: [ { x: 350, y: 580, w: 100, h: 20, target: 'VILLAGE', targetX: 600, targetY: 600 } ],
            npc: { x: 380, y: 200, w: 32, h: 40, module: moduleKey }
        };
    }
};

const MAPS = {
    VILLAGE: WORLDS.VILLAGE,
    HOUSE_1: WORLDS.INDOOR_TEMPLATE(QUIZ_DATA.MODULE_1.color, 'MODULE_1'),
    HOUSE_2: WORLDS.INDOOR_TEMPLATE(QUIZ_DATA.MODULE_2.color, 'MODULE_2'),
    HOUSE_3: WORLDS.INDOOR_TEMPLATE(QUIZ_DATA.MODULE_3.color, 'MODULE_3'),
    HOUSE_4: WORLDS.INDOOR_TEMPLATE(QUIZ_DATA.MODULE_4.color, 'MODULE_4'),
};

function startGame() {
    initMusic();
    document.getElementById('title-screen').style.display = 'none';
    gameStarted = true;
    gameLoop();
}

window.addEventListener('keydown', e => { keys[e.code] = true; checkInteraction(e.code); });
window.addEventListener('keyup', e => keys[e.code] = false);

function update() {
    if (gameState === 'DIALOGUE') return;

    // UPDATE POKEMONS
    if (currentZone === 'VILLAGE') {
        pokemons.forEach(p => {
            if (p.moveTimer <= 0) {
                p.moving = Math.random() > 0.5;
                p.dir = Math.floor(Math.random() * 4);
                p.moveTimer = Math.random() * 60 + 30;
            }
            p.moveTimer--;
            if (p.moving) {
                if (p.dir === 0) p.y += 1;
                if (p.dir === 1) p.y -= 1;
                if (p.dir === 2) p.x -= 1;
                if (p.dir === 3) p.x += 1;
                if (p.x < 0) p.x = 0; if (p.x > 1170) p.x = 1170;
                if (p.y < 0) p.y = 0; if (p.y > 1170) p.y = 1170;
            }
        });
    }

    // UPDATE JOUEUR
    player.moving = false;
    let speed = keys['ShiftLeft'] ? player.runSpeed : player.speed;
    let nextX = player.x; let nextY = player.y;

    if (keys['ArrowUp']) { nextY -= speed; player.dir = 1; player.moving = true; }
    if (keys['ArrowDown']) { nextY += speed; player.dir = 0; player.moving = true; }
    if (keys['ArrowLeft']) { nextX -= speed; player.dir = 2; player.moving = true; }
    if (keys['ArrowRight']) { nextX += speed; player.dir = 3; player.moving = true; }

    let currentMap = MAPS[currentZone];
    if (nextX < 0) nextX = 0;
    if (nextY < 0) nextY = 0;
    if (nextX > currentMap.w - player.w) nextX = currentMap.w - player.w;
    if (nextY > currentMap.h - player.h) nextY = currentMap.h - player.h;

    let teleported = false;
    currentMap.doors.forEach(door => {
        if (checkCollision({x: nextX, y: nextY, w: player.w, h: player.h}, door)) {
            currentZone = door.target;
            player.x = door.targetX; player.y = door.targetY;
            teleported = true;
            if (door.target === 'VILLAGE') { if (currentZone === 'HOUSE_1') { player.x = 245; player.y = 350; } }
        }
    });

    if (!teleported) { player.x = nextX; player.y = nextY; }

    // Camera
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;
    if (camera.x < 0) camera.x = 0;
    if (camera.y < 0) camera.y = 0;
    if (camera.x > currentMap.w - canvas.width) camera.x = currentMap.w - canvas.width;
    if (camera.y > currentMap.h - canvas.height) camera.y = currentMap.h - canvas.height;

    frameCount++;
}

function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);
    MAPS[currentZone].draw();
    drawPlayerSprite(player.x, player.y, player.dir, player.frame);
    ctx.restore();
}

function gameLoop() {
    if (!gameStarted) return;
    update();
    render();
    requestAnimationFrame(gameLoop);
}

function checkCollision(rect1, rect2) {
    return (rect1.x < rect2.x + rect2.w && rect1.x + rect1.w > rect2.x && rect1.y < rect2.y + rect2.h && rect1.y + rect1.h > rect2.y);
}

function checkInteraction(key) {
    if (key === 'Space' && gameState !== 'DIALOGUE') {
        if (currentZone !== 'VILLAGE') {
            let map = MAPS[currentZone];
            let dist = Math.hypot(player.x - map.npc.x, player.y - map.npc.y);
            if (dist < 80) startQuiz(map.npc.module);
        } else {
            pokemons.forEach(p => {
                let dist = Math.hypot(player.x - p.x, player.y - p.y);
                if (dist < 50) { showSimpleDialogue(p.anecdote.name, p.anecdote.text); }
            });
        }
    }
}

// UI / DIALOGUES
const uiBox = document.getElementById('dialogue-box');
const uiName = document.getElementById('npc-name');
const uiContent = document.getElementById('dialogue-content');
const uiOptions = document.getElementById('options');
let currentQuizQueue = []; let currentModuleKey = "";

function startQuiz(moduleKey) {
    let modIndex = parseInt(moduleKey.split('_')[1]) - 1;
    if (badges[modIndex]) { showSimpleDialogue("PNJ", "Tu as d√©j√† valid√© ce module. Excellent travail !"); return; }
    gameState = 'DIALOGUE';
    currentModuleKey = moduleKey;
    let data = QUIZ_DATA[moduleKey];
    currentQuizQueue = [...data.questions];
    uiBox.style.display = 'flex';
    uiName.innerText = data.name; uiName.style.color = data.color;
    uiContent.innerText = data.dialogue;
    uiOptions.innerHTML = `<button class="choice-btn" onclick="nextQuestion()">COMMENCER LE TEST</button>`;
}

function nextQuestion() {
    if (currentQuizQueue.length === 0) { victory(); return; }
    let q = currentQuizQueue.shift();
    uiContent.innerText = q.q;
    uiOptions.innerHTML = "";
    q.a.forEach((ans, idx) => {
        let btn = document.createElement('button');
        btn.className = 'choice-btn'; btn.innerText = ans;
        btn.onclick = () => {
            if (idx === q.correct) {
                uiContent.innerText = "Exact !";
                uiOptions.innerHTML = `<button class="choice-btn" onclick="nextQuestion()">Suivant ‚ñ∂</button>`;
            } else {
                uiContent.innerText = `Erreur... La r√©ponse √©tait : ${q.a[q.correct]}`;
                uiOptions.innerHTML = `<button class="choice-btn" onclick="closeDialogue()">Recommencer plus tard</button>`;
            }
        };
        uiOptions.appendChild(btn);
    });
}

function victory() {
    uiContent.innerText = "F√©licitations ! Tu ma√Ætrises ce sujet. Voici ton badge.";
    uiOptions.innerHTML = `<button class="choice-btn" onclick="closeDialogue(true)">G√©nial !</button>`;
}

function showSimpleDialogue(name, text) {
    gameState = 'DIALOGUE';
    uiBox.style.display = 'flex';
    uiName.innerText = name; uiContent.innerText = text;
    uiOptions.innerHTML = `<button class="choice-btn" onclick="closeDialogue()">Fermer</button>`;
}

function closeDialogue(win = false) {
    uiBox.style.display = 'none';
    gameState = 'OVERWORLD';
    if (win) {
        let modIndex = parseInt(currentModuleKey.split('_')[1]) - 1;
        badges[modIndex] = true;
        updateBadgesUI();
        if (badges.every(b => b)) {
            setTimeout(() => { alert("üéâ INCROYABLE C√âLIA ! TU AS OBTENU LES 4 BADGES ! TU ES PR√äTE POUR L'EXAMEN ! üéâ"); }, 500);
        }
    }
}

function updateBadgesUI() {
    const colors = ["#3498db", "#f1c40f", "#2ecc71", "#e67e22"];
    badges.forEach((b, i) => {
        if (b) {
            let el = document.getElementById(`badge-${i+1}`);
            el.style.backgroundColor = colors[i];
            el.classList.add('badge-active');
        }
    });
}
</script>
</body>
</html>